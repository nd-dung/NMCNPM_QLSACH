@model List<BTL_NMCNPM_SE.G19_QLNSNhaNam.Models.tblSach>
@{
    ViewBag.Title = "vSach";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Your Page Title</title>
    <link href="~/Front-end/css/book.css" rel="stylesheet" type="text/css" />
    <script src="~/Scripts/jquery-3.7.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Quản lý Sách</h1>
        <form action="/cSach/index">
            <div class="book-actions">
                <div class="search-bar">
                    <input type="text" id="searchInput" name="searchInput" value="@ViewBag.Search" placeholder="Nhập tên sách để tìm kiếm...">
                    <button id="searchBtn" type="submit" class="btn btn-secondary">Tìm kiếm</button>
                </div>
            </div>
        </form>

        <div style="display: flex; justify-content: end; margin: 16px 0;   ">
            <button id="addBookBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Thêm Sách Mới</button>
        </div>


        <table class="book-table">
            <thead>
                <tr>
                    <th>Mã Sách</th>
                    <th>Tên Sách</th>
                    <th>Tên tác Giả</th>
                    <th>Đơn Giá</th>
                    <th>Số Lượng</th>
                    <th>Nhà xuất bản</th>
                    <th>Thể Loại</th>
                    <th>Thao Tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.sMasach</td>
                        <td>@item.sTensach</td>
                        <td>@item.sTenTG</td>
                        <td>@item.iDongia</td>
                        <td>@item.iSoluong</td>
                        <td>@item.sNXB</td>
                        <td>@item.sTheloai</td>
                        <td class="action-buttons">
                            <button class="btn btn-secondary" onclick="onUpdate('@item.sMasach')">Sửa</button>
                            <button class="btn btn-danger" onclick="confirmDelete('@item.sMasach', '@item.sTensach')">Xóa</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="pagination">
            <button class="btn btn-secondary" id="prevPage">Trước</button>
            <span id="currentPage">Trang 1</span>
            <button class="btn btn-secondary" id="nextPage">Sau</button>
        </div>
    </div>

    <!-- Modal thêm/sửa sách -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle" class="mb-2">Thêm Sách Mới</h2>
            <form action="/cSach/add" id="bookForm" method="post">
                <p id="labelMaSach" class="label">Mã sách:</p>
                <input type="text" id="sMasach" name="sMasach" placeholder="Nhập Mã Sách" oninput="validateInput(event)" maxlength="10">
                <p id="errorMaSach" class="error"></p>

                <p class="label">Tên sách:</p>
                <input type="text" id="sTensach" name="sTensach" placeholder="Nhập Tên Sách" maxlength="100">
                <p id="errorTenSach" class="error"></p>

                <p class="label">Tên tác giả:</p>
                <input type="text" id="sTenTG" name="sTenTG" placeholder="Nhập Tác giả" maxlength="100">
                <p id="errorTenTG" class="error"></p>

                <p class="label">Đơn Giá:</p>
                <input type="number" id="iDongia" name="iDongia" placeholder="Nhập Đơn giá">
                <p id="errorDonGia" class="error"></p>

                <p class="label">Số Lượng:</p>
                <input type="number" id="iSoluong" value="0" name="iSoluong" placeholder="Nhập Số lượng">
                <p id="errorSoLuong" class="error"></p>

                <p class="label">Nhà Xuất Bản:</p>
                <input type="text" id="sNXB" name="sNXB" placeholder="Nhập Nhà xuất bản" maxlength="100">
                <p id="errorNXB" class="error"></p>

                <p class="label">Thể Loại:</p>
                <input type="text" id="sTheloai" name="sTheloai" placeholder="Nhập Thể loại">
                <p id="errorTheLoai" class="error"></p>


                <div class="form-buttons">
                    <button type="submit" id="bookModalBtn" class="btn btn-primary">Thêm</button>
                    <button type="reset" class="btn btn-secondary close-btn">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <script>

        $(document).ready(function () {
            // Open modal when clicking "Thêm Nhân Viên"
            $('#addBookBtn').click(function () {
                clearForm();
                resetError();
                $('#bookModal').css('display', 'block');
            });


            // Close modal when clicking the close button
            $('.close, .close-btn').click(function () {
                clearForm();
                resetError();
                $('#bookModal').css('display', 'none');
            });

            // Close modal when clicking outside of the modal
            $(window).click(function (event) {
                if (event.target.id === 'bookModal') {
                    clearForm();
                    resetError();
                    $('#bookModal').css('display', 'none');
                }
            });
        });

        function onUpdate(maSach) {
            document.getElementById('modalTitle').textContent = "Sửa Sách"
            document.getElementById('bookForm').action = "/cSach/update"
            document.getElementById('bookModalBtn').textContent = "Sửa"

            var listSach = @Html.Raw(ViewBag.JsonListSach);
            if (listSach && listSach.length > 0) {
                var sach = listSach.find(function(s) { return s.sMasach === maSach; });
                if (sach) {
                    document.getElementById('sMasach').type = "hidden";
                    document.getElementById('labelMaSach').style.display = "none";
                    $('#bookModal').css('display', 'block');
                    document.getElementById('sMasach').value = sach.sMasach;
                    document.getElementById('sTensach').value = sach.sTensach;
                    document.getElementById('sTenTG').value = sach.sTenTG;
                    document.getElementById('iDongia').value = sach.iDongia;
                    document.getElementById('iSoluong').value = sach.iSoluong;
                    document.getElementById('sNXB').value = sach.sNXB;
                    document.getElementById('sTheloai').value = sach.sTheloai;
                } else {
                    console.error('Không tìm thấy sách với mã: ' + maSach);
                }
            } else {
                console.error('Danh sách sách trống hoặc không hợp lệ');
            }
        }

        function validateInput(event) {
            const input = event.target;
            const value = input.value;

            // Chỉ cho phép chữ hoa và số, không quá 10 ký tự
            const regex = /^[A-Z0-9]{0,10}$/;

            if (!regex.test(value)) {
                // Nếu không hợp lệ, loại bỏ ký tự cuối cùng
                input.value = value.slice(0, -1);
            }
        }


        function clearForm() {
            document.getElementById('sMasach').value = "";
            document.getElementById('sTensach').value = "";
            document.getElementById('sTenTG').value = "";
            document.getElementById('iDongia').value = "";
            document.getElementById('iSoluong').value = "0";
            document.getElementById('sNXB').value = "";
            document.getElementById('sTheloai').value = "";
            document.getElementById('modalTitle').textContent = "Thêm Sách"
            document.getElementById('bookForm').action = "/cSach/add"
            document.getElementById('bookModalBtn').textContent = "Thêm"
            document.getElementById('sMasach').type = "block";
            document.getElementById('labelMaSach').style.display = "block";
        }


        function confirmDelete(sMasach, sTensach) {
            if (confirm(` Bạn có muốn xóa ${sTensach} không?`)) {
                $.ajax({
                    url: '@Url.Action("Delete", "cSach")',
                    type: 'POST',
                    data: { sMasach: sMasach },
                    success: function(result) {
                        // Chuyển hướng đến hành động Index sau khi xóa thành công
                        alert(`Sách ${sTensach} đã được xóa thành công! `);
                            window.location.href = '@Url.Action("Index", "cSach")';
                    },
                    error: function() {
                        alert('Xóa không thành công vui lòng thử lại!');
                    }
                });
            }
        }

        const formAdd = document.getElementById('bookForm');


        function checkValid() {
            let sMaSach = document.getElementById('sMasach');
            let sTenSach = document.getElementById('sTensach');
            let sTenTG = document.getElementById('sTenTG');
            let iDongia = document.getElementById('iDongia');
            let iSoluong = document.getElementById('iSoluong');
            let sNXB = document.getElementById('sNXB');
            let sTheloai = document.getElementById('sTheloai');
            let isValid = true;

            if (!sMaSach.value.trim()) {
                isValid = false;
                document.getElementById("errorMaSach").innerHTML = "Vui lòng nhập mã sách";
            }

            if (!sTenSach.value.trim()) {
                isValid = false;
                document.getElementById("errorTenSach").innerHTML = "Vui lòng nhập tên sách";
            }

            if (!sTenTG.value.trim()) {
                isValid = false;
                document.getElementById("errorTenTG").innerHTML = "Vui lòng nhập tên tác giả";
            }

            if (!iDongia.value.trim()) {
                isValid = false;
                document.getElementById("errorDonGia").innerHTML = "Vui lòng nhập đơn giá";
            }
            if (iDongia.value <= 0) {
                isValid = false;
                document.getElementById("errorDonGia").innerHTML = "Đơn giá phải là số dương";
            }
            if (!iSoluong.value.trim()) {
                isValid = false;
                document.getElementById("errorSoLuong").innerHTML = "Vui lòng nhập số lượng";
            }
            if (iSoluong.value < 0) {
                isValid = false;
                document.getElementById("errorSoLuong").innerHTML = "Số lượng phải là số dương";
            }
            if (!sNXB.value.trim()) {
                isValid = false;
                document.getElementById("errorNXB").innerHTML = "Vui lòng nhập nhà xuất bản";
            }
            if (!sTheloai.value.trim()) {
                isValid = false;
                document.getElementById("errorTheLoai").innerHTML = "Vui lòng nhập thể loại";
            }

            return isValid;
        }

        function resetError() {
            document.getElementById("errorMaSach").innerHTML = "";
            document.getElementById("errorTenSach").innerHTML = "";
            document.getElementById("errorTenTG").innerHTML = "";
            document.getElementById("errorDonGia").innerHTML = "";
            document.getElementById("errorSoLuong").innerHTML = "";
            document.getElementById("errorNXB").innerHTML = "";
            document.getElementById("errorTheLoai").innerHTML = "";
        }

        // Trong form thêm mới
        formAdd.addEventListener('submit', function (event) {
            event.preventDefault();
            let sMaSach = document.getElementById('sMasach');
            let sTenSach = document.getElementById('sTensach');
            let sTenTG = document.getElementById('sTenTG');
            let iDongia = document.getElementById('iDongia');
            let iSoluong = document.getElementById('iSoluong');
            let sNXB = document.getElementById('sNXB');
            let sTheloai = document.getElementById('sTheloai');
            resetError()

            let url = document.getElementById('bookForm').action;

            if (!checkValid()) {
                return;
            } else {
                $.ajax({
                    url: url.includes('/cSach/update') ? '@Url.Action("Update", "cSach")' :'@Url.Action("Add", "cSach")',
                    type: 'POST',
                    data: {
                        sMasach: sMasach.value,
                        sTenSach: sTenSach.value,
                        sTenTG: sTenTG.value,
                        iDongia: iDongia.value,
                        iSoluong: iSoluong.value,
                        sNXB: sNXB.value,
                        sTheloai: sTheloai.value
                    },
                    success: function (result) {
                        // Chuyển hướng đến hành động Index sau khi xóa thành công
                        window.location.href = '@Url.Action("Index", "cSach")';
                        if (url.includes('/cSach/update')) {
                            alert("Thông tin sách đã được cập nhật thành công.")
                        } else {
                            alert("Thông tin sách đã được thêm thành công.")
                        }
                    },
                    error: function (xhr) {
                        // Hiển thị thông báo lỗi từ phản hồi
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            alert(xhr.responseJSON.error);
                        } else {
                            alert(`${url.includes('/cSach/update') ? "Cập nhật" : "Thêm"} sách thất bại. Hãy thử lại!`);
                        }
                    }
                });
            }
        });



    </script>
</body>
</html>


